var helper=require("./helper"),extend=require("./extend"),fs=require("fs"),os=require("os"),readChunk=require("read-chunk"),fileType=require("file-type"),rimraf=require("rimraf"),dialog=require("./nwdialog"),zip=require("node-zip-dir"),unzip=require("file-zip"),EventDispatcher=function(){};function DirectoryApp(i){return this.username=os.userInfo().username,this.dataPath=nw.App.dataPath.split("\\").join("/"),this.userDir=this.dataPath+"/temp",this.iconsDirextory=this.userDir+"/icons",this.userPath=this.userDir+"/",this.iconsPath=this.iconsDirextory+"/",fs.mkdirSync(this.iconsDirextory,{recursive:!0}),this.optionsFile=this.userPath+"options.json",this.readOptions().then(function(i){_options=i}).catch(function(i){console.log("Error load options")}),dialog.setContext(i),this}_options=null,_defaultOptions={volume:.5,notify:!0,station:-1,stations:[],favorites:[]},_start=!1,fileType.minimumBytes=4100,Object.assign(EventDispatcher.prototype,{addEventListener:function(i,t){void 0===this._listeners&&(this._listeners={});var e=this._listeners;void 0===e[i]&&(e[i]=[]),-1===e[i].indexOf(t)&&e[i].push(t)},hasEventListener:function(i,t){if(void 0===this._listeners)return!1;var e=this._listeners;return void 0!==e[i]&&-1!==e[i].indexOf(t)},removeEventListener:function(i,t){if(void 0!==this._listeners){var e=this._listeners[i];if(void 0!==e){var n=e.indexOf(t);-1!==n&&e.splice(n,1)}}},dispatchEvent:function(i){if(void 0!==this._listeners){var t=this._listeners[i.type];if(void 0!==t){i.target=this;var e=[],n=0,s=t.length;for(n=0;n<s;n++)e[n]=t[n];for(n=0;n<s;n++)e[n].call(this,i)}}}}),DirectoryApp.prototype={removeIcon:function(i){var t=this.iconsPath+i+".png";if(fs.existsSync(t))try{fs.unlinkSync(t)}catch(i){}},getStationIndex:function(i){return _options.stations.findIndex(t=>t.id==i)},getIcon:function(i){var t=this.iconsPath+i+".png";return fs.existsSync(t)?t:"assets/images/favicon.png"},saveIcon:function(i,t){var e=this.iconsPath+i+".png";fs.mkdirSync(this.iconsDirextory,{recursive:!0}),fs.writeFileSync(e,t)},saveOptions:function(){var i=this;return new Promise(function(t,e){fs.mkdirSync(i.iconsDirextory,{recursive:!0}),_options=extend({},_defaultOptions,_options);var n=new Uint8Array(Buffer.from(helper.pack(_options)));fs.writeFile(i.optionsFile,n,function(i){i?e(i):t(_options)})})},readOptions:function(i){var t=this;return new Promise(function(e,n){fs.mkdirSync(t.iconsDirextory,{recursive:!0});try{if(i)try{fs.accessSync(t.optionsFile,fs.constants.F_OK|fs.constants.R_OK|fs.constants.W_OK)}catch(i){chrome.runtime.sendMessage(chrome.runtime.id,{sender:"errorimport",reload:!0,options:!1}),n("reloadlist")}fs.accessSync(t.optionsFile,fs.constants.F_OK|fs.constants.R_OK|fs.constants.W_OK);var s=helper.unpack(fs.readFileSync(t.optionsFile,"utf8"));_options=extend({},_defaultOptions,s),e(_options),_start||(chrome.runtime.sendMessage(chrome.runtime.id,{sender:"settings",reload:!0,options:_options}),_start=!0)}catch(i){rimraf(t.userPath,function(){setTimeout(function(){fs.mkdirSync(t.iconsDirextory,{recursive:!0}),unzip.unzip("radio-export.radiopack",t.userPath,function(i){i?n("Ошибка распаковки дефолта. "+i):(_start=!1,t.readOptions().then(function(i){e(_options),_start||(chrome.runtime.sendMessage(chrome.runtime.id,{sender:"settings",reload:!0,options:_options}),_start=!0)}).catch(function(i){n(i)}))})},200)})}})},isDev:function(){return nw.App.argv.findIndex(i=>"--dev"==i)>-1},export:function(){var i=this;return new Promise(function(t,e){i.saveOptions().then(function(n){dialog.saveFileDialog("radio-export.radiopack",[".radiopack"],function(n){if(n){n=n.split("\\").join("/");try{fs.unlinkSync(n)}catch(i){}zip.zip(i.userDir,n).then(function(){t(n)}).catch(function(i){e("Ошибка экспорта")})}else e(!1)})})})},import:function(){var i=this;return new Promise(function(t,e){fs.mkdirSync(i.iconsDirextory,{recursive:!0}),dialog.openFileDialog([".radiopack"],function(n){if(n){n=n.split("\\").join("/");var s=readChunk.sync(n,0,fileType.minimumBytes);try{if("application/zip"===fileType(s).mime)try{rimraf(i.userPath,function(){setTimeout(function(){fs.mkdirSync(i.iconsDirextory,{recursive:!0}),unzip.unzip(n,i.userPath,function(n){n?e("Ошибка Импорта! Распаковка "+n):(_start=!1,i.readOptions(!0).then(function(i){t(i)}).catch(function(i){e(i)}))})},200)})}catch(i){e("Ошибка Импорта! Создание директории")}else e("Ошибка Импорта! Данный формат не поддерживается")}catch(i){e("Ошибка Импорта! Данный формат не поддерживается")}}else e(!1)})})},get options(){if(!_options){_options=extend({},_defaultOptions,_options);var i=new Uint8Array(Buffer.from(helper.pack(_options)));fs.writeFileSync(this.optionsFile,i)}return _options},set options(i){_options=extend({},_defaultOptions,i);var t=new Uint8Array(Buffer.from(helper.pack(_options)));fs.writeFileSync(this.optionsFile,t)}},Object.assign(DirectoryApp.prototype,EventDispatcher.prototype),module.exports=DirectoryApp;