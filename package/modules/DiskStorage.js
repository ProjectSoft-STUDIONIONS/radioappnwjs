var DiskStorage={init:function(){var t,e=this,a=this.dbName||location.href.replace(/\/|:|#|%|\.|\[|\]/g,""),n=indexedDB.open(a,1);function o(t){t.createObjectStore(e.dataStoreName)}function i(){var a=t.transaction([e.dataStoreName],"readwrite");if(void 0!==e.data.key){var n;n=!0===e.data.remove?a.objectStore(e.dataStoreName).delete(e.data.key):!0===e.data.get?a.objectStore(e.dataStoreName).get(e.data.key):a.objectStore(e.dataStoreName).put(e.data.value,e.data.key);var o=e.data.key;n.onsuccess=function(){if("function"==typeof e.callback){if(!0===e.data.get){var t=e.callback;return e.callback=null,void t(event.target.result,o)}t=e.callback;e.callback=null,t("success",o)}},n.onerror=function(t){if("function"==typeof e.callback){e.callback(null,o,t);var a=e.callback;e.callback=null,a(null,o,t)}}}}n.onerror=e.onError,n.onsuccess=function(){((t=n.result).onerror=e.onError,t.setVersion)?1!==t.version?t.setVersion(1).onsuccess=function(){o(t),i()}:i():i()},n.onupgradeneeded=function(t){o(t.target.result)}},Fetch:function(t,e){return this.data={key:t,get:!0},this.callback=e,this.init(),this},Store:function(t,e){return this.data=t,this.callback=e,this.init(),this},Remove:function(t,e){return this.data={key:t,remove:!0},this.callback=e,this.init(),this},onError:function(t){console.error(t)},dataStoreName:"DiskStorage",dbName:"DiskStorage",data:{value:"",key:"key"},StoreStation:function(t,e){DiskStorage.Fetch("stations-list",function(a){a&&"success"!==a||(a=[]),a.push({name:t.name,display:t.name,youtube:"",php:""}),DiskStorage.Store({key:"stations-list",value:a},function(){DiskStorage.Store({key:t.name,value:t},e)})})},RemoveFile:function(t,e){DiskStorage.Fetch("stations-list",function(a){a&&"success"!==a||(a=[]);var n=[];a.forEach(function(e){"string"==typeof e?e!==t&&n.push({name:e,display:e,youtube:"",php:""}):"string"==typeof e.name&&e.name!==t&&n.push(e)}),a=n,DiskStorage.Store({key:"stations-list",value:a},function(){DiskStorage.Remove(t,e)})})},GetFilesList:function(t){DiskStorage.Fetch("stations-list",function(e){e&&"success"!==e||(e=[]);var a=[];e.reverse().forEach(function(t){"string"==typeof t?a.push({name:t,display:t,youtube:"",php:""}):a.push({name:t.name,display:t.display||t.name,youtube:t.youtube,php:t.php})}),t(a)})},GetLastSelectedFile:function(t,e){DiskStorage.GetFilesList(function(a){var n;a.length?t?(a.forEach(function(e){"string"==typeof e?e===t&&(n={name:e,display:e,php:"",youtube:""}):e.name===t&&(n=e)}),n?DiskStorage.Fetch(n.name,e):DiskStorage.Fetch(a[0].name||a[0],e)):DiskStorage.Fetch(a[0].name||a[0],e):e()})},UpdateFileName:function(t,e,a){e&&e.replace(/ /g,"").length||(e="unknown.webm"),e.split(".").length<=1&&(e=e.split(".")[0]+".webm"),DiskStorage.Fetch("stations-list",function(n){var o;if(n&&"success"!==n||(n=[]),n.forEach(function(t,a){t.name!==e&&t!==e||(o=!0)}),o)return e=e.split(".")[0]+"_."+e.split(".")[1],void DiskStorage.UpdateFileName(t,e,a);n.forEach(function(a,o){if("string"==typeof a){if(a!==t)return}else if("string"==typeof a.name&&a.name!==t)return;!0,a.name=e,n[o]=a}),DiskStorage.Store({key:"stations-list",value:n},function(){DiskStorage.Fetch(t,function(t){var n=new File([t],e,{type:t.type});DiskStorage.Store({key:n.name,value:n},function(){a(n)})})})})},UpdateFileInfo:function(t,e,a){DiskStorage.Fetch("stations-list",function(n){n&&"success"!==n||(n=[]),n.forEach(function(a,o){if("string"==typeof a){if(a!==t)return}else if("string"==typeof a.name&&a.name!==t)return;!0,Object.keys(e).forEach(function(t){a[t]=e[t]}),n[o]=a}),DiskStorage.Store({key:"stations-list",value:n},a)})}};module.exports=DiskStorage;