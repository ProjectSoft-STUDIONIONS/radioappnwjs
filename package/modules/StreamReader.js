const util=require("util"),Transform=require("stream").Transform,INIT_STATE=1,BUFFERING_STATE=2,PASSTHROUGH_STATE=3,METADATA_BLOCK_SIZE=16,_parseMetadata=t=>{const e={};return(Buffer.isBuffer(t)?t.toString("utf8"):t||"").replace(/\0*$/,"").split(";").forEach(t=>{t=t.split(/\=['"]/),e[t[0]]=String(t[1]).replace(/['"]$/,"")}),e},_trampoline=function(t){return function(){let e=t.apply(this,arguments);for(;"function"==typeof e;)e=e();return e}},_processData=(t,e,s)=>{if(t._bytesLeft-=e.length,t._currentState===BUFFERING_STATE?(t._buffers.push(e),t._buffersLength+=e.length):t._currentState===PASSTHROUGH_STATE&&t.push(e),0===t._bytesLeft){const s=t._callback;s&&t._currentState===BUFFERING_STATE&&t._buffers.length>1?e=Buffer.concat(t._buffers,t._buffersLength):t._currentState!==BUFFERING_STATE&&(e=null),t._currentState=INIT_STATE,t._callback=null,t._buffers.splice(0),t._buffersLength=0,s.call(t,e)}return s},_onData=_trampoline((t,e,s)=>e.length<=t._bytesLeft?()=>_processData(t,e,s):()=>{const r=e.slice(0,t._bytesLeft);return _processData(t,r,a=>a?s(a):e.length>r.length?()=>_onData(t,e.slice(r.length),s):void 0)});class StreamReader extends Transform{constructor(t){super(),this._bytesLeft=0,this._currentState=INIT_STATE,this._callback=null,this._buffers=[],this._buffersLength=0,this._icyMetaInt=+t,this._passthrough(this._icyMetaInt,this._onMetaSectionStart)}_bytes(t,e){return this._bytesLeft=t,this._currentState=BUFFERING_STATE,this._callback=e,this}_passthrough(t,e){return this._bytesLeft=t,this._currentState=PASSTHROUGH_STATE,this._callback=e,this}_transform(t,e,s){_onData(this,t,s)}_onMetaSectionStart(){this._bytes(1,this._onMetaSectionLengthByte)}_onMetaSectionLengthByte(t){const e=t[0]*METADATA_BLOCK_SIZE;e>0?this._bytes(e,this._onMetaData):this._passthrough(this._icyMetaInt,this._onMetaSectionStart)}_onMetaData(t){this.emit("metadata",_parseMetadata(t)),this._passthrough(this._icyMetaInt,this._onMetaSectionStart)}}module.exports=StreamReader;